{% extends 'base.html.twig' %}

{% block title %}D√©tail de la sortie{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1 class="mb-4">{{ sortie.nom }}</h1>



    <div class="card shadow-sm">
        <div class="card-body">
            {% if sortie.imagePrincipale %}
                <div class="text-center mb-3">
                    <img src="{{ asset('images/sorties/' ~ (sortie.imagePrincipale ?: 'default.png')) }}"
                         alt="Image de {{ sortie.nom }}"
                         class="img-fluid rounded shadow-sm"
                         style="max-height: 300px;">
                </div>
            {% else %}
                <p class="text-muted text-center">Aucune image disponible pour cette sortie.</p>
            {% endif %}
            <dl class="row mb-0">
                <dt class="col-sm-3">Date de d√©but</dt>
                <dd class="col-sm-9">{{ sortie.dateHeureDebut ? sortie.dateHeureDebut|date('d/m/Y H\\hi') : '' }}</dd>

                <dt class="col-sm-3">Cl√¥ture inscriptions</dt>
                <dd class="col-sm-9">{{ sortie.dateLimiteInscription ? sortie.dateLimiteInscription|date('d/m/Y H\\hi') : '' }}</dd>

                <dt class="col-sm-3">Dur√©e</dt>
                <dd class="col-sm-9">{{ sortie.duree }}</dd>

                <dt class="col-sm-3">Places max</dt>
                <dd class="col-sm-9">{{ sortie.nbInscriptionsMax }}</dd>

                <dt class="col-sm-3">Lieu</dt>
                <dd class="col-sm-9">{{ sortie.lieu ? sortie.lieu.nom : '' }}</dd>

                <dt class="col-sm-3">Site</dt>
                <dd class="col-sm-9">{{ sortie.site ? sortie.site.nom : '' }}</dd>

                <dt class="col-sm-3">Informations</dt>
                <dd class="col-sm-9">{{ sortie.infosSortie }}</dd>
            </dl>

            <div class="card mt-4">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        M√©t√©o pr√©vue √† {{ sortie.lieu.ville.nom }} le {{ sortie.dateHeureDebut|date('d/m/Y') }}
                    </h5>
                    <div
                            id="meteo-widget"
                            data-ville="{{ sortie.lieu.ville.nom }}"
                            data-date="{{ sortie.dateHeureDebut|date('Y-m-d') }}"
                    >
                        <p>Chargement de la m√©t√©o...</p>
                    </div>
                </div>
            </div>

            <div class="card mt-4" style="width: 18rem;">
                <div class="card-body">
                    <h5 class="card-title">Participants</h5>
                    <div>{{ sortie.participants|length }} participant(s)</div>

                    <div class="mt-3" style="max-height: 200px; overflow-y: auto;">
                        {% if sortie.participants is not empty %}
                            <ul class="list-group list-group-flush small">
                                {% for participant in sortie.participants %}
                                    <li class="list-group-item d-flex align-items-center justify-content-between py-2">
                                        <a href="{{ path('app_profile_show', {id: participant.id}) }}" class="text-decoration-none fw-semibold">
                                            {{ participant.prenom }} {{ participant.nom }}
                                        </a>
                                        {% if participant.imageProfil %}
                                            <img src="{{ asset('images/uploads/' ~ participant.imageProfil) }}"
                                                 alt="Photo de {{ participant.prenom }}"
                                                 class="rounded-circle" width="35" height="35">
                                        {% else %}
                                            <img src="{{ asset('images/default-profile.jpg') }}"
                                                 alt="Photo de {{ participant.prenom }}"
                                                 class="rounded-circle" width="35" height="35">
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted small">Aucun participant pour le moment.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card mt-4" style="width: 100%;">
                <div class="card-body">
                    <h5 class="card-title">üí¨ Chat des participants</h5>

                    <div id="chat-messages"
                         class="border rounded p-2 mb-3 bg-light"
                         style="height: 250px; overflow-y: auto;"
                         data-send-url="{{ path('chat_send', {id: sortie.id}) }}"
                         data-fetch-url="{{ path('chat_fetch', {id: sortie.id}) }}">
                    </div>


                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="√âcrire un message...">
                        <button id="chat-send" class="btn btn-primary">Envoyer</button>
                    </div>
                </div>
            </div>





            <div class="mt-3 d-flex gap-2">
                <a href="{{ path('app_sortie_index') }}" class="btn btn-secondary">Retour</a>
                <a href="{{ path('app_sortie_edit', {id: sortie.id}) }}" class="btn btn-primary">Modifier</a>
                <form method="post" action="{{ path('app_sortie_delete', {id: sortie.id}) }}" onsubmit="return confirm('Supprimer cette sortie ?');">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ sortie.id) }}">
                    <button class="btn btn-outline-danger" type="submit">Supprimer</button>
                </form>
                {% if sortie.etat.libelle == 'Cr√©√©e' %}
                    <form method="post" action="{{ path('app_sortie_publish', {'id': sortie.id}) }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('publish' ~ sortie.id) }}">
                        <button class="btn btn-primary">Publier la sortie</button>
                    </form>
                {% endif %}
            </div>
            {% if sortie.etat.libelle == 'Pass√©e' and app.user in sortie.participants  %}
                <h2>Commentaires</h2>
                <p>Note moyenne : {{ noteMoyenne ? noteMoyenne|number_format(1, ',', ' ') ~ '/5' : 'Pas encore not√©e' }}</p>

                {% for commentaire in sortie.commentaires %}
                    <div class="comment">
                        <p><strong>{{ commentaire.auteur.prenom }} :</strong></p>
                        <p>{{ commentaire.message }}</p>
                        <p>Note :
                            {% for i in 1..commentaire.note %}
                                ‚≠ê
                            {% endfor %}
                        </p>
                        <small>Post√© le {{ commentaire.createdAt|date('d-m-Y H:i:s') }}</small>

                        {% if app.user and (commentaire.auteur == app.user or is_granted('ROLE_ADMIN')) %}
                            <a href="{{ path('commentaire_edit', { id: commentaire.id }) }}" class="btn btn-sm btn-outline-warning">
                                ‚úèÔ∏è Modifier
                            </a>
                        {% endif %}
                        <form method="post" action="{{ path('commentaire_delete', {id: commentaire.id}) }}" onsubmit="return confirm('Supprimer ce commentaire ?');">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ commentaire.id) }}">
                            <button class="btn btn-danger" type="submit">Supprimer</button>
                        </form>
                    </div>
                {% else %}
                    <p>Aucun commentaire pour le moment.</p>
                {% endfor %}

                {% set dejaCommente = sortie.commentaires|filter(c => c.auteur == app.user)|length == 0 %}

                {% if app.user%}
                    {% if dejaCommente %}
                        <h3>Laisser un commentaire</h3>
                        {{ form_start(commentaireForm) }}
                        {{ form_row(commentaireForm.message) }}
                        {{ form_row(commentaireForm.note) }}
                        <button class="btn btn-primary">Envoyer</button>
                        {{ form_end(commentaireForm) }}
                    {% endif %}
                {% else %}
                    <p><a href="{{ path('app_login') }}">Connecte-toi</a> pour laisser un commentaire.</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

    <script src="{{ asset('js/meteo.js') }}"></script>
    <script src="{{ asset('js/chat.js') }}"></script>


{% endblock %}






