{% extends 'base.html.twig' %}

{% block title %}D√©tail du lieu{% endblock %}

{% block body %}


            <button class="md:hidden flex items-center justify-center size-10 rounded-lg bg-secondary-light dark:bg-secondary-dark">
                <span class="material-symbols-outlined text-text-light dark:text-text-dark">menu</span>
            </button>
        <main class="flex flex-1 justify-center py-8 px-4 sm:px-8 md:px-10">
            <div class="layout-content-container flex flex-col max-w-6xl flex-1 gap-8">
                <div class="flex flex-wrap gap-2 px-4">
                    <a class="text-subtle-light dark:text-subtle-dark text-sm font-medium leading-normal" href="{{ path('app_sortie_index') }}">Sorties</a>
                    <span class="text-subtle-light dark:text-subtle-dark text-sm font-medium leading-normal">/</span>
                    <span class="text-text-light dark:text-text-dark text-sm font-medium leading-normal">{{ sortie.nom }}</span>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 px-4">
                    <div class="lg:col-span-2 flex flex-col gap-8">
                        <div class="flex flex-col gap-3">
                            <p class="text-text-light dark:text-text-dark text-4xl md:text-5xl font-black leading-tight tracking-[-0.033em]">{{ sortie.nom }}</p>
                            <p class="text-subtle-light dark:text-subtle-dark text-base md:text-lg font-normal leading-normal">{{ sortie.dateHeureDebut ? sortie.dateHeureDebut|date('d/m/Y H\\hi') : '' }}</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            {% if app.user %}
                                {% set etat = sortie.etat.libelle %}
                                {% set maintenant = "now"|date('U') %}
                                {% set dateLimiteInscription = sortie.dateLimiteInscription ? sortie.dateLimiteInscription|date('U') : 0 %}
                                {% set placesDisponibles = (sortie.nbInscriptionsMax - sortie.participants|length) > 0 %}
                                {% set inscrit = sortie.participants.contains(app.user) %}
                                {% set dateLimiteAtteinte = dateLimiteInscription and dateLimiteInscription < maintenant %}

                                {% if inscrit %}
                                    {# Bouton D√©sinscription actif ou d√©sactiv√© avec tooltip #}
                                    {% set canUnsubscribe = etat in ['Ouverte', 'Cr√©√©e'] or (etat == 'Cl√¥tur√©e' and not dateLimiteAtteinte) %}
                                    <form method="post" action="{{ path('app_sortie_unsubscribe', {'id': sortie.id}) }}?tab=disponibles" onclick="event.stopPropagation();">
                                        <input type="hidden" name="_token" value="{{ csrf_token('unsubscribe' ~ sortie.id) }}">
                                        <button
                                                class="flex w-full sm:w-auto min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-6 bg-primary text-text-light text-base font-bold leading-normal tracking-[0.015em]"
                                                type="submit"
                                                {% if not canUnsubscribe %}disabled aria-disabled="true" title="D√©sinscription ferm√©e : date limite d√©pass√©e ou sortie cl√¥tur√©e"{% endif %}
                                        >
                                            <span class="material-symbols-outlined mr-2">remove_circle</span>
                                            Se d√©sinscrire
                                        </button>
                                    </form>

                                {% else %}
                                    {# Bouton Inscription visible uniquement si ouvert et places dispos #}
                                    {% if etat == 'Ouverte' and placesDisponibles and not dateLimiteAtteinte %}
                                        <form method="post" action="{{ path('app_sortie_subscribe', {'id': sortie.id}) }}?tab=disponibles" onclick="event.stopPropagation();">
                                            <input type="hidden" name="_token" value="{{ csrf_token('subscribe' ~ sortie.id) }}">
                                            <button class="flex w-full sm:w-auto min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-6 bg-primary text-text-light text-base font-bold leading-normal tracking-[0.015em]">
                                                <span class="material-symbols-outlined mr-2">add_circle</span>
                                                S'inscrire
                                            </button>
                                        </form>
                                    {% else %}
                                        <span class="flex w-full sm:w-auto min-w-[84px] items-center justify-center overflow-hidden rounded-xl h-12 px-6 bg-primary text-text-light text-base font-bold leading-normal tracking-[0.015em]" title="Inscription ferm√©e">Inscription ferm√©e</span>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <a class="flex w-full sm:w-auto min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-6 bg-primary text-text-light text-base font-bold leading-normal tracking-[0.015em]" href="#" data-bs-toggle="modal" data-bs-target="#loginModal" onclick="event.stopPropagation();">Se connecter</a>
                            {% endif %}

                            {% if app.user and (sortie.organisateur.id == app.user.id or 'ROLE_ADMIN' in app.user.roles) %}
                                {% if sortie.etat.libelle == 'Cr√©√©e' %}
                                    <a href="{{ path('app_sortie_edit', { id: sortie.id }) }}"
                                       class="flex w-full sm:w-auto min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-6 border border-primary text-primary text-base font-bold leading-normal tracking-[0.015em]">
                                        <span class="material-symbols-outlined mr-2">edit</span>
                                        <span class="truncate">Modifier</span>
                                    </a>
                                {% endif %}
                            {% endif %}
                            <a href="{{ path('app_sortie_pdf', { id: sortie.id }) }}"
                               class="flex w-full sm:w-auto min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-6 border border-primary text-primary text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary hover:text-white transition">
                                <span class="material-symbols-outlined mr-2">picture_as_pdf</span>
                                <span class="truncate">Exporter en PDF</span>
                            </a>


                        </div>
                        <div class="border-t border-secondary-light dark:border-secondary-dark pt-8 flex flex-col gap-6">
                            <div class="flex items-center gap-4 bg-background-light dark:bg-background-dark min-h-14 justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="text-text-light dark:text-text-dark flex items-center justify-center rounded-lg bg-secondary-light dark:bg-secondary-dark shrink-0 size-12">
                                        <span class="material-symbols-outlined">location_on</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <p class="text-text-light dark:text-text-dark text-base font-bold leading-normal flex-1">Lieu</p>
                                        <p class="text-subtle-light dark:text-subtle-dark text-base font-normal leading-normal flex-1 truncate">{{ sortie.lieu.nom }},<br> {{ sortie.lieu.rue }}, {{ sortie.lieu.ville.nom }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-start gap-4">
                                <div class="text-text-light dark:text-text-dark flex items-center justify-center rounded-lg bg-secondary-light dark:bg-secondary-dark shrink-0 size-12 mt-1">
                                    <span class="material-symbols-outlined">description</span>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <p class="text-text-light dark:text-text-dark text-base font-bold leading-normal">Informations diverses</p>
                                    <p class="text-subtle-light dark:text-subtle-dark text-base font-normal leading-relaxed">{{ sortie.infosSortie }}</p>
                                </div>
                            </div>
                            <div class="p-6 rounded-xl bg-secondary-light dark:bg-secondary-dark flex flex-col gap-4">
                                <h3 class="text-text-light dark:text-text-dark text-xl font-bold">
                                    üí¨ Chat des participants
                                </h3>

                                <div
                                        id="chat-messages"
                                        class="flex flex-col gap-3 h-64 overflow-y-auto pr-2 bg-background-light dark:bg-background-dark rounded-lg p-3 border border-subtle-light/20 dark:border-subtle-dark/20"
                                        data-send-url="{{ path('chat_send', {id: sortie.id}) }}"
                                        data-fetch-url="{{ path('chat_fetch', {id: sortie.id}) }}"
                                >
                                    <!-- Messages charg√©s dynamiquement -->
                                    <p class="text-subtle-light dark:text-subtle-dark text-sm text-center">Chargement du chat...</p>
                                </div>

                                <div class="flex items-center gap-2 pt-4 border-t border-subtle-light/20 dark:border-subtle-dark/20">
                                    <input
                                            id="chat-input"
                                            type="text"
                                            placeholder="√âcrire un message..."
                                            class="flex-1 bg-background-light dark:bg-background-dark rounded-lg p-3 text-sm border-none focus:ring-2 focus:ring-primary focus:outline-none"
                                    />
                                    <button
                                            id="chat-send"
                                            class="bg-primary text-text-light rounded-lg p-3 flex items-center justify-center hover:opacity-90 transition"
                                    >
                                        <span class="material-symbols-outlined">send</span>
                                    </button>
                                </div>
                            </div>

                            <div>
                                {% if sortie.etat.libelle == 'Pass√©e' and app.user in sortie.participants %}
                                    <div class="p-6 rounded-xl bg-secondary-light dark:bg-secondary-dark flex flex-col gap-6">
                                        <h3 class="text-text-light dark:text-text-dark text-xl font-bold">
                                            üí¨ Commentaires & Notes
                                        </h3>

                                        <p class="text-subtle-light dark:text-subtle-dark text-sm">
                                            Note moyenne :
                                            <span class="font-semibold">
                {{ noteMoyenne ? noteMoyenne|number_format(1, ',', ' ') ~ '/5' : 'Pas encore not√©e' }}
            </span>
                                        </p>

                                        {# üí¨ Liste des commentaires #}
                                        <div class="border-t border-subtle-light/20 dark:border-subtle-dark/20 pt-4 flex flex-col gap-6">
                                            {% for commentaire in sortie.commentaires %}
                                                <div class="flex items-start gap-4">
                                                    {# Avatar (profil ou image par d√©faut) #}
                                                    <div
                                                            class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10"
                                                            style="background-image: url('{{ commentaire.auteur.imageProfil
                                                            ? asset('images/uploads/' ~ commentaire.auteur.imageProfil)
                                                            : asset('images/default-avatar.png') }}');">
                                                    </div>

                                                    <div class="flex flex-col flex-1">
                                                        <div class="flex items-center justify-between">
                                                            <p class="text-text-light dark:text-text-dark font-bold text-sm">
                                                                {{ commentaire.auteur.prenom }}
                                                            </p>
                                                            <p class="text-subtle-light dark:text-subtle-dark text-xs">
                                                                {{ commentaire.createdAt|date('d/m/Y H:i') }}
                                                            </p>
                                                        </div>

                                                        <div class="mt-1">
                                                            <p class="text-text-light dark:text-text-dark text-sm">
                                                                {{ commentaire.message }}
                                                            </p>
                                                        </div>

                                                        <div class="mt-2 flex items-center gap-1">
                                                            {% for i in 1..commentaire.note %}
                                                                <span class="text-yellow-400 text-base">‚≠ê</span>
                                                            {% endfor %}
                                                            {% if commentaire.note is empty %}
                                                                <span class="text-subtle-light dark:text-subtle-dark text-xs italic">Pas de note</span>
                                                            {% endif %}
                                                        </div>

                                                        {# Boutons modifier/supprimer #}
                                                        {% if app.user and (commentaire.auteur == app.user or is_granted('ROLE_ADMIN')) %}
                                                            <div class="mt-2 flex gap-2">
                                                                <a href="{{ path('commentaire_edit', { id: commentaire.id }) }}"
                                                                   class="text-xs bg-yellow-400 hover:bg-yellow-500 text-white px-2 py-1 rounded transition">
                                                                    ‚úèÔ∏è Modifier
                                                                </a>
                                                                <form method="post" action="{{ path('commentaire_delete', {id: commentaire.id}) }}"
                                                                      onsubmit="return confirm('Supprimer ce commentaire ?');">
                                                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ commentaire.id) }}">
                                                                    <button type="submit"
                                                                            class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition">
                                                                        üóëÔ∏è Supprimer
                                                                    </button>
                                                                </form>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% else %}
                                                <p class="text-subtle-light dark:text-subtle-dark italic text-sm">
                                                    Aucun commentaire pour le moment.
                                                </p>
                                            {% endfor %}
                                        </div>

                                        {# üí¨ Formulaire pour laisser un commentaire #}
                                        {% set dejaCommente = sortie.commentaires|filter(c => c.auteur == app.user)|length == 0 %}
                                        {% if app.user %}
                                            {% if dejaCommente %}
                                                <div class="mt-6 border-t border-subtle-light/20 dark:border-subtle-dark/20 pt-4">
                                                    <h4 class="text-text-light dark:text-text-dark text-lg font-semibold mb-2">
                                                        Laisser un commentaire
                                                    </h4>
                                                    {{ form_start(commentaireForm, {'attr': {'class': 'flex flex-col gap-4'}}) }}
                                                    {{ form_row(commentaireForm.message, {'attr': {'class': 'w-full bg-background-light dark:bg-background-dark rounded-lg p-3 text-sm'}}) }}
                                                    {{ form_row(commentaireForm.note, {'attr': {'class': 'w-24'}}) }}
                                                    <button class="self-start mt-2 px-4 py-2 bg-primary text-text-light rounded-lg text-sm font-bold hover:opacity-90 transition">
                                                        Envoyer
                                                    </button>
                                                    {{ form_end(commentaireForm) }}
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <p class="text-subtle-light dark:text-subtle-dark text-sm">
                                                <a href="{{ path('app_login') }}" class="text-primary hover:underline">Connecte-toi</a>
                                                pour laisser un commentaire.
                                            </p>
                                        {% endif %}
                                    </div>
                                {% endif %}

                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-6">
                        <div class="lg:col-span-1">
                            <div class="p-6 rounded-xl bg-secondary-light dark:bg-secondary-dark flex flex-col gap-4 items-center text-center">
                                <h3 class="text-text-light dark:text-text-dark text-xl font-bold">
                                    M√©t√©o de {{ sortie.lieu.ville.nom }} <br>
                                    le {{ sortie.dateHeureDebut|date('d/m/Y') }}
                                </h3>

                                <div id="meteo-widget" class="flex flex-col items-center gap-2" data-ville="{{ sortie.lieu.ville.nom }}" data-date="{{ sortie.dateHeureDebut|date('Y-m-d') }}">
                                    <!-- Contenu charg√© dynamiquement -->
                                    <p class="text-subtle-light dark:text-subtle-dark">Chargement de la m√©t√©o...</p>
                                </div>
                            </div>
                        </div>


                        <!-- Image principale -->
                        {% if sortie.imagePrincipale %}
                            <div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl object-cover shadow"
                                 style="background-image: url('{{ asset('images/sorties/' ~ sortie.imagePrincipale) }}');"
                                 data-alt="Image principale de la sortie"></div>
                        {% else %}
                            <div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl object-cover shadow"
                                 style="background-image: url('{{ asset('images/sorties/default.png') }}');"
                                 data-alt="Image par d√©faut"></div>
                        {% endif %}

                        <!-- Bloc participants -->
                        <div class="flex flex-col gap-4 p-6 rounded-xl bg-secondary-light dark:bg-secondary-dark">
                            <h3 class="text-text-light dark:text-text-dark text-xl font-bold">
                                Participants ({{ sortie.participants|length }})
                            </h3>

                            {% if sortie.participants is not empty %}
                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-3 gap-4">
                                    {% for participant in sortie.participants %}
                                        <div class="flex flex-col items-center gap-2 text-center">
                                            <div class="rounded-full overflow-hidden size-16 border-2 border-primary shadow-sm">
                                                <img
                                                        src="{{ participant.imageProfil
                                                        ? asset('images/uploads/' ~ participant.imageProfil)
                                                        : asset('images/default-profile.jpg') }}"
                                                        alt="Photo de {{ participant.prenom }}"
                                                        class="w-full h-full object-cover"
                                                >
                                            </div>
                                            <a href="{{ path('app_profile_show', {id: participant.id}) }}"
                                               class="text-text-light dark:text-text-dark text-sm font-medium leading-normal truncate hover:underline">
                                                {{ participant.prenom }} {{ participant.nom }}
                                            </a>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-subtle-light dark:text-subtle-dark text-sm italic">
                                    Aucun participant pour le moment.
                                </p>
                            {% endif %}
                        </div>
                    </div>




                </div>
                </div>

{% endblock %}

{% block javascripts %}
    <script src="{{ asset('js/meteo.js') }}"></script>
    <script src="{{ asset('js/chat.js') }}"></script>
{% endblock %}

