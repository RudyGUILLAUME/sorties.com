<div class="card shadow-sm">
    <div class="table-responsive">
        {% if sorties is empty %}
            <p class="text-center py-4 text-muted">Aucune sortie à afficher.</p>
        {% else %}
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                <tr>
                    <th>Nom de la sortie</th>
                    <th>Date de la sortie</th>
                    <th>Clôture inscriptions</th>
                    <th>Places max</th>
                    <th>Etat</th>
                    <th>Inscription</th>
                    <th>Organisateur</th>
                    {% if app.user %}
                        <th class="text-end">Actions</th>
                    {% endif %}
                </tr>
                </thead>
                <tbody>
                {% for s in sorties %}
                    <tr style="cursor: pointer;" onclick="window.location='{{ path('app_sortie_show', {id: s.id}) }}';">
                        <td>{{ s.nom }}</td>
                        <td>{{ s.dateHeureDebut ? s.dateHeureDebut|date('d/m/Y H\\hi') : '' }}</td>
                        <td>{{ s.dateLimiteInscription ? s.dateLimiteInscription|date('d/m/Y H\\hi') : '' }}</td>
                        <td>{{ s.participants|length }} / {{ s.nbInscriptionsMax }}</td>
                        <td>{{ s.etat.libelle }}</td>
                        <td>
                            {% if app.user %}
                                {% set etat = s.etat.libelle %}
                                {% set maintenant = "now"|date('U') %}
                                {% set dateLimiteInscription = s.dateLimiteInscription ? s.dateLimiteInscription|date('U') : 0 %}
                                {% set placesDisponibles = (s.nbInscriptionsMax - s.participants|length) > 0 %}
                                {% set inscrit = s.participants.contains(app.user) %}
                                {% set dateLimiteAtteinte = dateLimiteInscription and dateLimiteInscription < maintenant %}

                                {% if inscrit %}
                                    {# Bouton Désinscription actif ou désactivé avec tooltip #}
                                    {% set canUnsubscribe = etat in ['Ouverte', 'Créée'] or (etat == 'Clôturée' and not dateLimiteAtteinte) %}
                                    <form method="post" action="{{ path('app_sortie_unsubscribe', {'id': s.id}) }}?tab=disponibles" onclick="event.stopPropagation();">
                                        <input type="hidden" name="_token" value="{{ csrf_token('unsubscribe' ~ s.id) }}">
                                        <button
                                                class="btn btn-warning btn-sm"
                                                type="submit"
                                                {% if not canUnsubscribe %}disabled aria-disabled="true" title="Désinscription fermée : date limite dépassée ou sortie clôturée"{% endif %}
                                        >
                                            Se désinscrire
                                        </button>
                                    </form>

                                {% else %}
                                    {# Bouton Inscription visible uniquement si ouvert et places dispos #}
                                    {% if etat == 'Ouverte' and placesDisponibles and not dateLimiteAtteinte %}
                                        <form method="post" action="{{ path('app_sortie_subscribe', {'id': s.id}) }}?tab=disponibles" onclick="event.stopPropagation();">
                                            <input type="hidden" name="_token" value="{{ csrf_token('subscribe' ~ s.id) }}">
                                            <button class="btn btn-success btn-sm">S'inscrire</button>
                                        </form>
                                    {% else %}
                                        <span class="badge bg-danger" title="Inscription fermée">Inscription fermée</span>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <a class="btn btn-primary btn-sm" href="#" data-bs-toggle="modal" data-bs-target="#loginModal" onclick="event.stopPropagation();">Se connecter</a>
                            {% endif %}
                        </td>

                        <td>
                            <a href="{{ path('app_profile_show', {id: s.organisateur.id}) }}" onclick="event.stopPropagation();">
                                {{ s.organisateur.prenom }} {{ s.organisateur.nom }}
                            </a>
                        </td>

                        {% if app.user and (s.organisateur.id == app.user.id or 'ROLE_ADMIN' in app.user.roles) %}
                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group" onclick="event.stopPropagation();">
                                    {% if s.etat.libelle == 'Créée' %}
                                        <a class="btn btn-outline-secondary" href="{{ path('app_sortie_edit', {id: s.id}) }}">Modifier</a>
                                    {% endif %}
                                    {% if (s.organisateur == app.user or 'ROLE_ADMIN') and s.etat.libelle == 'Créée' %}
                                        <form method="post" action="{{ path('app_sortie_delete', {id: s.id}) }}" onsubmit="return confirm('Supprimer cette sortie ?');">
                                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ s.id) }}">
                                            <button class="btn btn-outline-danger" type="submit">Supprimer</button>
                                        </form>
                                    {% endif %}
                                    {% if (s.organisateur == app.user or 'ROLE_ADMIN') and s.etat.libelle not in ['Annulée', 'Passée','Créée','Activité en cours'] %}
                                        <form method="post" action="{{ path('app_sortie_cancel', {'id': s.id}) }}" onsubmit="return confirm('Confirmer l\'annulation ?');">
                                            <input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ s.id) }}">
                                            <button class="btn btn-outline-danger">Annuler la sortie</button>
                                        </form>
                                    {% endif %}
                                    {% if s.etat.libelle == 'Créée' %}
                                        <form method="post" action="{{ path('app_sortie_publish', {'id': s.id}) }}">
                                            <input type="hidden" name="_token" value="{{ csrf_token('publish' ~ s.id) }}">
                                            <button class="btn btn-primary">Publier la sortie</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>
</div>
