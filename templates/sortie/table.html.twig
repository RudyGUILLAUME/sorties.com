<div class="card shadow-sm">
    <div class="table-responsive">
        {% if sorties is empty %}
            <p class="text-center py-4 text-muted">Aucune sortie à afficher.</p>
        {% else %}
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                <tr>
                    <th>Nom de la sortie</th>
                    <th>Date de la sortie</th>
                    <th>Clôture inscriptions</th>
                    <th>Places max</th>
                    <th>Etat</th>
                    <th>Inscription</th>
                    <th>Organisateur</th>
                    {% if app.user %}
                        <th class="text-end">Actions</th>
                    {% endif %}
                </tr>
                </thead>
                <tbody>
                {% for s in sorties %}
                    <tr style="cursor: pointer;" onclick="window.location='{{ path('app_sortie_show', {id: s.id}) }}';">
                        <td>{{ s.nom }}</td>
                        <td>{{ s.dateHeureDebut ? s.dateHeureDebut|date('d/m/Y H\\hi') : '' }}</td>
                        <td>{{ s.dateLimiteInscription ? s.dateLimiteInscription|date('d/m/Y H\\hi') : '' }}</td>
                        <td>{{ s.participants|length }} / {{ s.nbInscriptionsMax }}</td>
                        <td>{{ s.etat.libelle }}</td>
                        <td>
                            {% if app.user %}
                                {% set etat = s.etat.libelle %}
                                {% set maintenant = "now"|date('U') %}
                                {% set dateLimiteInscription = s.dateLimiteInscription ? s.dateLimiteInscription|date('U') : 0 %}
                                {% set placesDisponibles = (s.nbInscriptionsMax - s.participants|length) > 0 %}

                                {% if s.participants.contains(app.user) %}
                                    <div class="mb-1"><span class="badge bg-info text-dark">Inscrit</span></div>

                                    {% if etat in ['Ouverte', 'En création', 'Clôturée'] %}
                                        <form method="post" action="{{ path('app_sortie_unsubscribe', {'id': s.id}) }}" onclick="event.stopPropagation();">
                                            <input type="hidden" name="_token" value="{{ csrf_token('unsubscribe' ~ s.id) }}">
                                            <button class="btn btn-warning btn-sm" type="submit">Se désinscrire</button>
                                        </form>
                                    {% else %}
                                        <span class="badge bg-danger">Désinscription fermée</span>
                                    {% endif %}
                                {% else %}
                                    {% if etat == 'Ouverte' and placesDisponibles and dateLimiteInscription > maintenant %}
                                        <form method="post" action="{{ path('app_sortie_subscribe', {'id': s.id}) }}" onclick="event.stopPropagation();">
                                            <input type="hidden" name="_token" value="{{ csrf_token('subscribe' ~ s.id) }}">
                                            <button class="btn btn-success btn-sm" type="submit">S'inscrire</button>
                                        </form>
                                    {% else %}
                                        <span class="badge bg-danger">Inscription fermée</span>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <a class="btn btn-primary btn-sm" href="#" data-bs-toggle="modal" data-bs-target="#loginModal" onclick="event.stopPropagation();">Se connecter</a>
                            {% endif %}
                        </td>

                        <td>
                            <a href="{{ path('app_profile_show', {id: s.organisateur.id}) }}" onclick="event.stopPropagation();">
                                {{ s.organisateur.prenom }} {{ s.organisateur.nom }}
                            </a>
                        </td>
                        {% if app.user %}
                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group" onclick="event.stopPropagation();">
                                    <a class="btn btn-outline-secondary" href="{{ path('app_sortie_edit', {id: s.id}) }}">Modifier</a>
                                    <form method="post" action="{{ path('app_sortie_delete', {id: s.id}) }}" onsubmit="return confirm('Supprimer cette sortie ?');">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ s.id) }}">
                                        <button class="btn btn-outline-danger" type="submit">Supprimer</button>
                                    </form>
                                    {% if s.organisateur == app.user and s.etat.libelle not in ['Annulée', 'Clôturée', 'Passée'] %}
                                        <form method="post" action="{{ path('app_sortie_cancel', {'id': s.id}) }}" onsubmit="return confirm('Confirmer l\'annulation ?');">
                                            <input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ s.id) }}">
                                            <button class="btn btn-outline-danger">Annuler la sortie</button>
                                        </form>
                                    {% endif %}
                                    {% if s.etat.libelle == 'En création' %}
                                        <form method="post" action="{{ path('app_sortie_publish', {'id': s.id}) }}">
                                            <input type="hidden" name="_token" value="{{ csrf_token('publish' ~ s.id) }}">
                                            <button class="btn btn-primary">Publier la sortie</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>
</div>
